<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>쉐키나 찬양팀 곡 검색</title>

  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f1733;
      --card:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --bd:rgba(17,24,39,.10);
      --shadow: 0 12px 45px rgba(0,0,0,.18);
      --shadow2: 0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
      --chip:#f3f4f6;
      --ok:#065f46;
      --warn:#991b1b;
      --accent:#7aa2ff;
      --accent2:#8ef0d0;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--fg);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.22), transparent 60%),
        radial-gradient(1000px 700px at 95% 10%, rgba(142,240,208,.18), transparent 55%),
        linear-gradient(160deg, var(--bg0), var(--bg1));
      padding-bottom: calc(76px + env(safe-area-inset-bottom));
    }

    .wrap{ max-width:1080px; margin:0 auto; padding:18px 16px; }
    @media (min-width:900px){ .wrap{ padding:22px; } }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(11,16,32,.45), transparent);
      backdrop-filter: blur(10px);
      padding: calc(10px + env(safe-area-inset-top)) 0 12px;
    }
    .topbarInner{
      max-width:1080px; margin:0 auto; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      color:#e8ecff;
    }
    .brandTitle{
      font-weight:900; letter-spacing:-.3px;
      font-size:16px;
    }
    .brandSub{
      font-size:12px; color:rgba(232,236,255,.75);
      line-height:1.35;
    }
    .topStatus{
      display:flex; align-items:center; gap:8px;
      color:rgba(232,236,255,.92);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(232,236,255,.55);
      box-shadow: 0 0 0 4px rgba(232,236,255,.10);
    }

    .card{
      background: var(--card);
      border:1px solid var(--bd);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .muted{ color:var(--muted); font-size:12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    .chip{
      font-size:12px;
      background:var(--chip);
      padding:3px 9px;
      border-radius:999px;
      color:#374151;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .chip.ok{ background: rgba(220,252,231,.9); color:var(--ok); }
    .chip.warn{ background: rgba(254,226,226,.9); color:var(--warn); }

    .miniBtn, .btn, .clearBtn{
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      border-radius:12px;
      padding:8px 12px;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      color:var(--fg);
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .miniBtn:hover, .btn:hover, .clearBtn:hover{ background:#fafafa; }
    .miniBtn.active{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
      font-weight:900;
    }

    .searchWrap{ position:relative; }
    input[type="text"]{
      width:100%;
      padding:12px 46px 12px 12px;
      border:1px solid rgba(17,24,39,.14);
      border-radius:14px;
      font-size:15px;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
      background:#fff;
    }
    input[type="text"]:focus{
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
    }
    .clearBtn{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      padding:7px 10px;
      border-radius:12px;
    }

    .status{
      font-size:12px;
      white-space:pre-wrap;
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status.ok{ color:var(--ok); }
    .status.bad{ color:var(--warn); }
    .spin{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(17,24,39,.2);
      border-top-color:rgba(17,24,39,.65);
      animation:spin .8s linear infinite;
      display:none;
    }
    .status.loading .spin{ display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .list{
      border:1px solid rgba(17,24,39,.10);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .list .head{
      padding:10px 12px;
      background:#fafafa;
      border-bottom:1px solid rgba(17,24,39,.10);
      font-weight:900;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .list .body{
      max-height: 420px;
      overflow:auto;
      scroll-behavior:smooth;

      /* ✅ (수정) iOS 모멘텀 스크롤 + 터치 안정화 */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .item{
      padding:10px 12px;
      border-bottom:1px solid rgba(17,24,39,.10);
      font-size:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition:background .12s ease;
      background:#fff;

      /* ✅ 터치 클릭 안정화 */
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .item:hover{ background:#fafafa; }
    .item:last-child{ border-bottom:0; }
    .empty{ color:var(--muted); font-size:13px; padding:12px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid rgba(17,24,39,.10); padding:10px 10px; text-align:left; font-size:14px; }
    th{
      font-size:13px; color:#374151; background:#fafafa;
      position:sticky; top:0; z-index:1;
    }

    .ac{
      position:absolute; left:0; right:0; top:calc(100% + 8px);
      border:1px solid rgba(17,24,39,.10);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow2);
      display:none;
      z-index:10;
    }
    .acHead{
      padding:8px 10px;
      background:#fafafa;
      border-bottom:1px solid rgba(17,24,39,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:#374151;
    }
    .acBody{ max-height:260px; overflow:auto; -webkit-overflow-scrolling: touch; }
    .acRow{
      padding:10px 12px;
      border-bottom:1px solid rgba(17,24,39,.10);
      display:flex; justify-content:space-between; gap:10px;
      cursor:pointer; font-size:14px;
      background:#fff;
    }
    .acRow:last-child{ border-bottom:0; }
    .acRow:hover, .acRow.active{ background:#f9fafb; }
    mark{
      background:rgba(253,230,138,.55);
      padding:0 2px;
      border-radius:4px;
    }

    .personLink{ text-decoration:underline; cursor:pointer; color:#1f2937; }
    .personLink:hover{ color:#111827; }
    .panelHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .panelTitle{ font-weight:900; }
    .panelMeta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .dateChips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .dateChip{ font-size:12px; }

    .mediaBox{ border-top:1px solid rgba(17,24,39,.10); padding:12px; background:#fff; }
    .mediaRow{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; margin-top:8px; }
    .mediaLabel{ font-size:12px; color:var(--muted); min-width:44px; padding-top:2px; }
    .mediaLinks{ display:flex; gap:6px; flex-wrap:wrap; }
    a.chipLink{ text-decoration:none; }

    .filterRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .filterLeft{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .filterRight{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    select{
      border:1px solid rgba(17,24,39,.14);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      background:#fff;
      cursor:pointer;
      outline:none;
    }
    select:focus{
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
    }

    .poomWrap{ margin-top:10px; }
    .poomDateRow{ display:flex; align-items:center; gap:8px; margin-top:12px; }
    .poomDateRow:first-child{ margin-top:6px; }
    .poomLines{ margin-top:6px; }
    .poomLine{ margin-top:6px; line-height:1.6; }
    .poomTag{
      font-weight:900;
      padding:1px 7px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.14);
      background:#fafafa;
      margin-right:6px;
      display:inline-block;
      font-size:12px;
      vertical-align:middle;
    }
    .poomTag.singer{ border-color: rgba(6,95,70,.25); }
    .poomTag.inst{ border-color: rgba(17,24,39,.20); }
    .poomText{ vertical-align:middle; }

    .chipBtn{
      cursor:pointer;
      border-color: rgba(17,24,39,.14);
      background:#fff;
    }
    .chipBtn:hover{ background:#fafafa; }
    .chipBtn.active{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
      font-weight:900;
      background:#fff;
    }

    .view{ display:none; }
    .view.active{ display:block; }

    .nav{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(11,16,32,.86);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(232,236,255,.12);
      z-index:60;
    }
    .navInner{
      max-width:1080px; margin:0 auto;
      display:flex; gap:10px; justify-content:space-between;
    }
    .navBtn{
      flex:1;
      border:1px solid rgba(232,236,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(232,236,255,.92);
      border-radius:16px;
      padding:10px 10px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      touch-action: manipulation;
    }
    .navBtn.active{
      background: rgba(122,162,255,.20);
      border-color: rgba(122,162,255,.45);
      box-shadow: 0 0 0 4px rgba(122,162,255,.14);
    }

    .modalDim{
      position:fixed; inset:0;
      background: rgba(0,0,0,.50);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    .modalDim.show{ display:flex; }
    .modal{
      width:100%;
      max-width:720px;
      background:#fff;
      border-radius: 22px;
      border:1px solid rgba(17,24,39,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      background:#fafafa;
      border-bottom:1px solid rgba(17,24,39,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalTitle{ font-weight:900; font-size:14px; }
    .modalBody{
      padding:14px;
      font-size:14px;
      line-height:1.65;
      white-space:pre-wrap;
    }
    .modalActions{
      padding:12px 14px;
      border-top:1px solid rgba(17,24,39,.10);
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      background:#fff;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .divider{ height:1px; background: rgba(17,24,39,.10); margin:10px 0; }

    @media (max-width: 900px){
      #resultPaneBody{
        max-height: none !important;
        overflow: visible !important;
        padding-bottom: 24px;
      }
      #resultPaneBody th{
        position: static !important;
      }
    }

    /* ===== 캘린더(달력형) ===== */
    .calTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .calMonth{
      font-weight:900;
      font-size:14px;
      display:flex; align-items:center; gap:10px;
    }
    .calGrid{
      margin-top:12px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .calWeekHead{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      background:#fafafa;
      border-bottom:1px solid rgba(17,24,39,.10);
    }
    .calWeekHead div{
      padding:10px 8px;
      font-size:12px;
      color:#374151;
      font-weight:900;
      text-align:center;
    }
    .calCells{
      display:grid;
      grid-template-columns:repeat(7,1fr);
    }
    .calCell{
      min-height:110px;
      border-right:1px solid rgba(17,24,39,.08);
      border-bottom:1px solid rgba(17,24,39,.08);
      padding:8px;
      cursor:pointer;
      background:#fff;
      transition: background .12s ease;
      position:relative;
      overflow:hidden;
    }
    .calCell:hover{ background:#fafafa; }
    .calCell:nth-child(7n){ border-right:0; }
    .calCell.dim{
      background:#fcfcfd;
      color:rgba(17,24,39,.45);
    }
    .calDayRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:6px;
      margin-bottom:6px;
    }
    .calDayNum{
      font-weight:900;
      font-size:12px;
      color:#111827;
    }
    .calCell.dim .calDayNum{ color:rgba(17,24,39,.45); }
    .calTodayDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(122,162,255,.9);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
      display:none;
      flex:0 0 auto;
    }
    .calCell.today .calTodayDot{ display:inline-block; }
    .calEvents{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .calChip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      font-size:12px;
      line-height:1.2;
      color:#111827;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      touch-action: manipulation;
    }
    .calChip:hover{ background:#fafafa; }
    .calMore{
      font-size:12px;
      color:#374151;
      padding:6px 8px;
      border-radius:12px;
      background:var(--chip);
      border:1px solid transparent;
      display:inline-flex;
      width:fit-content;
    }

    .calDots{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      align-items:center;
      padding-top:2px;
    }
    .calDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgba(122,162,255,.85);
      box-shadow: 0 0 0 3px rgba(122,162,255,.14);
      flex:0 0 auto;
    }
    .calDot.dim{
      background: rgba(17,24,39,.20);
      box-shadow: none;
    }
    .calPlus{
      font-size:12px;
      padding:2px 7px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid transparent;
      color:#374151;
      font-weight:900;
      line-height:1.4;
    }

    @media (max-width: 520px){
      .calCell{ min-height:96px; padding:7px; }
      .calChip{ display:none !important; }
      .calMore{ display:none !important; }
      .calDots{ margin-top:6px; }
    }
    @media (hover: none) and (pointer: coarse) {
      #resultPaneBody{
        max-height: none !important;
        overflow: visible !important;
        padding-bottom: 140px !important;
      }
    }
    @media (hover: none) and (pointer: coarse) {
      .list .body{
        max-height: none !important;
        overflow: visible !important;
      }
    }

    /* ===== 콘티 탭 하단 액션바(악보/복사/새로고침) ===== */
    .slActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;

      position: sticky;
      bottom: calc(10px + 76px + env(safe-area-inset-bottom)); /* 하단 네비 높이만큼 위 */
      z-index: 70;

      background: rgba(255,255,255,.96);
      backdrop-filter: blur(10px);
      padding: 10px 0;
      border-top: 1px solid rgba(17,24,39,.10);

      /* ✅ (수정) 액션바 "빈 영역"이 아래 아이템 터치 가로채지 않게 */
      pointer-events: none;
    }
    /* ✅ (수정) 버튼/링크만 터치되게 */
    .slActions .miniBtn,
    .slActions .btn,
    .slActions a,
    .slActions button{
      pointer-events: auto;
    }

    /* ✅ (수정) 콘티 리스트 마지막 곡이 액션바/하단네비에 가리지 않게 */
    #slBody{
      padding-bottom: calc(160px + env(safe-area-inset-bottom));
      scroll-padding-bottom: calc(160px + env(safe-area-inset-bottom));
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="brandTitle">쉐키나 찬양팀</div>
        <div class="brandSub">곡 검색 · 콘티 · 캘린더 · 공지</div>
      </div>
      <div class="topStatus">
        <span class="dot" id="topDot"></span>
        <span id="topStatusText">연결 대기</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- ===== VIEW 1: 곡 검색 ===== -->
    <section id="viewSearch" class="view active">
      <div class="card">
        <label>곡명 검색</label>

        <div class="searchWrap">
          <input id="q" type="text" placeholder="곡명 검색" autocomplete="off" />
          <button id="clear" class="clearBtn" type="button" title="지우기">지우기</button>

          <div id="ac" class="ac" aria-hidden="true">
            <div class="acHead">
              <span>검색 후보</span>
              <span id="acMeta" class="chip">0</span>
            </div>
            <div id="acBody" class="acBody"></div>
          </div>
        </div>

        <div id="status" class="status">
          <span class="spin" aria-hidden="true"></span>
          <span id="statusText"></span>
        </div>
      </div>

      <div class="card" id="filterCard">
        <div class="panelHead">
          <div class="panelTitle">곡 목록 필터</div>
          <span class="chip" id="filterCount">0</span>
        </div>

        <div class="filterRow" style="margin-top:10px;">
          <div class="filterLeft">
            <button class="miniBtn" id="modeRecent" type="button">최근 들은곡</button>
            <button class="miniBtn" id="modeFrequent" type="button">자주</button>
            <button class="miniBtn" id="modeOld" type="button">안들은곡</button>

            <span class="chip" id="weeksChip">12주</span>

            <select id="weeksSel" title="기간(주)">
              <option value="4">4주</option>
              <option value="8">8주</option>
              <option value="12" selected>12주</option>
              <option value="24">24주</option>
              <option value="52">52주</option>
            </select>

            <select id="sortSel" title="정렬">
              <option value="default" selected>기본 정렬</option>
              <option value="az">가나다</option>
            </select>

            <button class="miniBtn" id="filterReset" type="button">초기화</button>
          </div>

          <div class="filterRight">
            <span class="chip" id="noDateChip" title="날짜가 없는 곡 수" style="display:none;">날짜없음 0</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="list">
          <div class="head">
            <span id="songListTitle">곡 목록</span>
            <span class="chip" id="songCount">0</span>
          </div>
          <div class="body" id="songs"></div>
        </div>

        <div class="list">
          <div class="head">검색 결과</div>
          <div class="body" id="resultPaneBody">
            <div id="resultsEmpty" class="empty">검색어를 입력해 주세요.</div>

            <table id="resultsTable" style="display:none;">
              <thead>
                <tr><th style="width:40%;">파트</th><th>담당자</th></tr>
              </thead>
              <tbody id="results"></tbody>
            </table>

            <div id="mediaBox" class="mediaBox" style="display:none;">
              <div style="font-weight:900; margin-bottom:2px;">자료</div>

              <div class="mediaRow" id="scoreRow" style="display:none;">
                <div class="mediaLabel">악보</div>
                <div class="mediaLinks" id="scoreLinks"></div>
              </div>

              <div class="mediaRow" id="videoRow" style="display:none;">
                <div class="mediaLabel">영상</div>
                <div class="mediaLinks" id="videoLinks"></div>
              </div>
            </div>

            <div id="metaBox" style="display:none; border-top:1px solid rgba(17,24,39,.10); padding:12px;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div>
                  <div style="font-weight:900; margin-bottom:4px;">송품</div>
                  <div class="muted" id="metaSong"></div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <a id="metaScoreBtn" class="btn" href="#" target="_blank" rel="noopener" style="display:none; text-decoration:none;">악보</a>
                  <a id="metaLinkBtn" class="btn" href="#" target="_blank" rel="noopener" style="display:none; text-decoration:none;">링크</a>
                </div>
              </div>

              <div id="poomDateTabs" class="dateChips" style="margin-top:10px;"></div>
              <div id="poomByDate" class="poomWrap"></div>
              <div id="poomCommon" class="muted" style="margin-top:10px; white-space:pre-wrap;"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="personPanel" class="card" style="display:none;">
        <div class="panelHead">
          <div class="panelTitle"><span id="ppName"></span></div>
          <div class="panelMeta">
            <span class="chip" id="ppSongCount">0곡</span>
            <button class="miniBtn" id="ppClose" type="button">닫기</button>
          </div>
        </div>

        <div class="list" style="margin-top:10px;">
          <div class="head"><span>참여 곡</span><span class="chip" id="ppRowCount">0행</span></div>
          <div class="body" id="ppBody"></div>
        </div>
      </div>
    </section>

    <!-- ===== VIEW 2: 콘티 ===== -->
    <section id="viewSetlists" class="view">
      <div class="card" id="setlistsCard">
        <div class="panelHead">
          <div class="panelTitle">콘티</div>
          <span class="chip" id="slBadge">-</span>
        </div>

        <div id="slTabs" class="dateChips" style="margin-top:10px;"></div>
        <div id="slDayTabs" class="dateChips" style="margin-top:10px; display:none;"></div>

        <div class="list" style="margin-top:12px;">
          <div class="head">
            <span id="slTitle">-</span>
            <span class="chip" id="slCount">0</span>
          </div>
          <div class="body" id="slBody" style="max-height:520px;"></div>
        </div>

        <div id="slActions" class="slActions">
          <a class="miniBtn" id="slScoreBtn" href="#" target="_blank" rel="noopener" style="display:none; text-decoration:none;">악보</a>
          <button class="miniBtn" id="slCopyBtn" type="button">복사</button>
          <button class="miniBtn" id="slReloadBtn" type="button">새로고침</button>
        </div>
      </div>
    </section>

    <!-- ===== VIEW 3: 캘린더(달력형) ===== -->
    <section id="viewCalendar" class="view">
      <div class="card">
        <div class="panelHead">
          <div class="panelTitle">캘린더</div>
          <span class="chip" id="calCount">0</span>
        </div>

        <div class="calTop" style="margin-top:10px;">
          <div class="calMonth">
            <button class="miniBtn" id="calPrev" type="button">이전</button>
            <span id="calMonthLabel">-</span>
            <button class="miniBtn" id="calNext" type="button">다음</button>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" id="calToday" type="button">오늘</button>
            <button class="miniBtn" id="calReload" type="button">새로고침</button>
          </div>
        </div>

        <div class="calGrid" id="calGrid">
          <div class="calWeekHead">
            <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
          </div>
          <div class="calCells" id="calCells"></div>
        </div>
      </div>
    </section>

    <!-- ===== VIEW 4: 공지 ===== -->
    <section id="viewNotice" class="view">
      <div class="card">
        <div class="panelHead">
          <div class="panelTitle">공지사항</div>
          <span class="chip" id="noticeCount">0</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="filterLeft">
            <button class="miniBtn" id="noticeReload" type="button">새로고침</button>
          </div>
          <div class="filterRight">
            <span class="chip" id="noticeSourceChip">공지사항</span>
          </div>
        </div>

        <div class="list" style="margin-top:12px;">
          <div class="head">
            <span>공지 목록</span>
            <span class="chip" id="noticeChip">-</span>
          </div>
          <div class="body" id="noticeBody" style="max-height:620px;"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="nav">
    <div class="navInner">
      <button class="navBtn active" id="navSearch" type="button">곡 검색</button>
      <button class="navBtn" id="navSetlists" type="button">콘티</button>
      <button class="navBtn" id="navCalendar" type="button">캘린더</button>
      <button class="navBtn" id="navNotice" type="button">공지</button>
    </div>
  </div>

  <div class="modalDim" id="noticeModalDim" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="noticeModalTitle">
      <div class="modalHead">
        <div>
          <div class="modalTitle" id="noticeModalTitle">공지</div>
          <div class="muted" id="noticeModalMeta" style="margin-top:4px;"></div>
        </div>
        <button class="miniBtn" id="noticeModalClose" type="button">닫기</button>
      </div>
      <div class="modalBody" id="noticeModalBody"></div>
      <div class="modalActions" id="noticeModalActions"></div>
    </div>
  </div>

  <div class="modalDim" id="calModalDim" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calModalTitle">
      <div class="modalHead">
        <div>
          <div class="modalTitle" id="calModalTitle">일정</div>
          <div class="muted" id="calModalMeta" style="margin-top:4px;"></div>
        </div>
        <button class="miniBtn" id="calModalClose" type="button">닫기</button>
      </div>
      <div class="modalBody" id="calModalBody"></div>
      <div class="modalActions" id="calModalActions"></div>
    </div>
  </div>

<script>
  /* ====== 이하 스크립트 원본 그대로 ====== */
  const FIXED_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1fyGPILf7sxYSBLx1gq7hFeZwV0enO0F3ufh-9DmbJp0/edit?gid=1851883768#gid=1851883768';
  const FIXED_GID = '1851883768';
  const FIXED_SHEET_NAME = 'DB';

  const META_SHEET_NAME = 'META';
  const META_GID = '';

  const SETLIST_TABS = [
    { key: "sunday", title: "주일 콘티", sheet: "주일콘티" },
    { key: "winter2026", title: "2026 겨울수련회 콘티", sheet: "2026겨울수련회콘티" },
    { key: "summer2026", title: "2026 여름수련회 콘티", sheet: "2026여름수련회콘티" },
  ];

  const NOTICE_SHEET_NAME = "공지사항";
  const CALENDAR_SHEET_NAME = "캘린더";

  const KST_TZ = "Asia/Seoul";
  const KST_OFFSET_HOURS = 9;

  function norm(s){
    return (s ?? "").toString().replace(/[\s\u200B\u200C\u200D\uFEFF]+/g, "").toLowerCase();
  }
  const trim = (s) => (s ?? "").toString().trim();

  function nowKSTParts(){
    const now = new Date();
    const parts = new Intl.DateTimeFormat("en-US", {
      timeZone: KST_TZ,
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      hour12: false,
    }).formatToParts(now);

    const map = {};
    for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;
    return {
      y: parseInt(map.year, 10),
      m: parseInt(map.month, 10),
      d: parseInt(map.day, 10),
      hh: parseInt(map.hour, 10),
      mm: parseInt(map.minute, 10),
      ss: parseInt(map.second, 10),
    };
  }

  function nowKSTTs(){
    const p = nowKSTParts();
    return Date.UTC(p.y, p.m - 1, p.d, p.hh - KST_OFFSET_HOURS, p.mm, p.ss);
  }

  function fmtYmdKST(ts){
    if (!ts) return "";
    return new Intl.DateTimeFormat("en-CA", {
      timeZone: KST_TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    }).format(new Date(ts));
  }

  function normDateStr(d){
    const s = trim((d ?? "").toString());
    if (!s) return "";

    let m = s.match(/Date\(\s*(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})/i);
    if (m){
      const y = m[1];
      const mm = String(parseInt(m[2],10)+1).padStart(2,"0");
      const dd = String(parseInt(m[3],10)).padStart(2,"0");
      return `${y}-${mm}-${dd}`;
    }

    m = s.match(/^(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})/);
    if (m){
      const y = m[1];
      const mm = String(parseInt(m[2],10)).padStart(2,"0");
      const dd = String(parseInt(m[3],10)).padStart(2,"0");
      return `${y}-${mm}-${dd}`;
    }

    m = s.match(/^(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})/);
    if (m){
      const y = m[1];
      const mm = m[2].padStart(2,"0");
      const dd = m[3].padStart(2,"0");
      return `${y}-${mm}-${dd}`;
    }

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    return s;
  }

  function toDateTs(v){
    const s = normDateStr(v);
    if (!s) return null;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const [y, m, d] = s.split("-").map(n => parseInt(n,10));
      const ts = Date.UTC(y, m-1, d, -KST_OFFSET_HOURS, 0, 0);
      return Number.isFinite(ts) ? ts : null;
    }
    return null;
  }

  function escapeHTML(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function highlight(text, queryNorm){
    if (!queryNorm) return escapeHTML(text);
    const raw = (text ?? "").toString();
    const rawNoSpace = raw.replace(/[\s\u200B\u200C\u200D\uFEFF]+/g, "");
    const idx = rawNoSpace.toLowerCase().indexOf(queryNorm);
    if (idx < 0) return escapeHTML(raw);

    let start=-1, end=-1, count=0;
    for (let i=0;i<raw.length;i++){
      const ch=raw[i];
      if (/[\s\u200B\u200C\u200D\uFEFF]/.test(ch)) continue;
      if (count===idx) start=i;
      if (count===idx+queryNorm.length-1){ end=i; break; }
      count++;
    }
    if (start<0 || end<0) return escapeHTML(raw);
    return escapeHTML(raw.slice(0,start)) + "<mark>" + escapeHTML(raw.slice(start,end+1)) + "</mark>" + escapeHTML(raw.slice(end+1));
  }

  function uniqueBy(arr, keyFn){
    const seen = new Set();
    const out = [];
    for (const x of arr){
      const k = keyFn(x);
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function extractSheetId(url){
    const m = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : null;
  }

  function parseLabeledLinks(cellText, defaultLabel){
    const text = (cellText ?? "").toString();
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

    const out = [];
    for (const line of lines){
      const m = line.match(/(https?:\/\/\S+)/i);
      if (!m) continue;
      const url = m[1].trim();
      const label = line.replace(url, "").trim() || defaultLabel;
      out.push({ label, url });
    }
    return out;
  }

  function extractFirstUrl(text){
    const m = (text ?? "").toString().match(/https?:\/\/\S+/i);
    return m ? m[0].trim() : "";
  }

  const elTopDot = document.getElementById("topDot");
  const elTopStatusText = document.getElementById("topStatusText");

  const elViewSearch = document.getElementById("viewSearch");
  const elViewSetlists = document.getElementById("viewSetlists");
  const elViewCalendar = document.getElementById("viewCalendar");
  const elViewNotice = document.getElementById("viewNotice");

  const elNavSearch = document.getElementById("navSearch");
  const elNavSetlists = document.getElementById("navSetlists");
  const elNavCalendar = document.getElementById("navCalendar");
  const elNavNotice = document.getElementById("navNotice");

  const elQ = document.getElementById("q");
  const elClear = document.getElementById("clear");

  const elSongs = document.getElementById("songs");
  const elSongCount = document.getElementById("songCount");
  const elSongListTitle = document.getElementById("songListTitle");

  const elResultsEmpty = document.getElementById("resultsEmpty");
  const elResultsTable = document.getElementById("resultsTable");
  const elResults = document.getElementById("results");

  const elMediaBox = document.getElementById("mediaBox");
  const elScoreRow = document.getElementById("scoreRow");
  const elVideoRow = document.getElementById("videoRow");
  const elScoreLinks = document.getElementById("scoreLinks");
  const elVideoLinks = document.getElementById("videoLinks");

  const elMetaBox = document.getElementById("metaBox");
  const elMetaSong = document.getElementById("metaSong");
  const elMetaScoreBtn = document.getElementById("metaScoreBtn");
  const elMetaLinkBtn = document.getElementById("metaLinkBtn");
  const elPoomDateTabs = document.getElementById("poomDateTabs");
  const elPoomByDate = document.getElementById("poomByDate");
  const elPoomCommon = document.getElementById("poomCommon");

  const elStatus = document.getElementById("status");
  const elStatusText = document.getElementById("statusText");

  const elAC = document.getElementById("ac");
  const elACBody = document.getElementById("acBody");
  const elACMeta = document.getElementById("acMeta");

  const elPersonPanel = document.getElementById("personPanel");
  const elPPName = document.getElementById("ppName");
  const elPPSongCount = document.getElementById("ppSongCount");
  const elPPRowCount = document.getElementById("ppRowCount");
  const elPPBody = document.getElementById("ppBody");
  const elPPClose = document.getElementById("ppClose");

  const elSlTabs = document.getElementById("slTabs");
  const elSlDayTabs = document.getElementById("slDayTabs");
  const elSlTitle = document.getElementById("slTitle");
  const elSlCount = document.getElementById("slCount");
  const elSlBody = document.getElementById("slBody");
  const elSlScoreBtn = document.getElementById("slScoreBtn");
  const elSlCopyBtn = document.getElementById("slCopyBtn");
  const elSlReloadBtn = document.getElementById("slReloadBtn");
  const elSlBadge = document.getElementById("slBadge");

  const elModeRecent = document.getElementById("modeRecent");
  const elModeFrequent = document.getElementById("modeFrequent");
  const elModeOld = document.getElementById("modeOld");
  const elWeeksSel = document.getElementById("weeksSel");
  const elWeeksChip = document.getElementById("weeksChip");
  const elSortSel = document.getElementById("sortSel");
  const elFilterReset = document.getElementById("filterReset");
  const elFilterCount = document.getElementById("filterCount");
  const elNoDateChip = document.getElementById("noDateChip");

  const elNoticeBody = document.getElementById("noticeBody");
  const elNoticeCount = document.getElementById("noticeCount");
  const elNoticeChip = document.getElementById("noticeChip");
  const elNoticeReload = document.getElementById("noticeReload");
  const elNoticeSourceChip = document.getElementById("noticeSourceChip");

  const elNoticeModalDim = document.getElementById("noticeModalDim");
  const elNoticeModalClose = document.getElementById("noticeModalClose");
  const elNoticeModalTitle = document.getElementById("noticeModalTitle");
  const elNoticeModalMeta = document.getElementById("noticeModalMeta");
  const elNoticeModalBody = document.getElementById("noticeModalBody");
  const elNoticeModalActions = document.getElementById("noticeModalActions");

  const elCalCount = document.getElementById("calCount");
  const elCalPrev = document.getElementById("calPrev");
  const elCalNext = document.getElementById("calNext");
  const elCalToday = document.getElementById("calToday");
  const elCalReload = document.getElementById("calReload");
  const elCalMonthLabel = document.getElementById("calMonthLabel");
  const elCalCells = document.getElementById("calCells");

  const elCalModalDim = document.getElementById("calModalDim");
  const elCalModalClose = document.getElementById("calModalClose");
  const elCalModalTitle = document.getElementById("calModalTitle");
  const elCalModalMeta = document.getElementById("calModalMeta");
  const elCalModalBody = document.getElementById("calModalBody");
  const elCalModalActions = document.getElementById("calModalActions");

  function setTopStatus(text, ok=true){
    elTopStatusText.textContent = text;
    elTopDot.style.background = ok ? "rgba(142,240,208,.85)" : "rgba(255,180,180,.85)";
    elTopDot.style.boxShadow = ok ? "0 0 0 4px rgba(142,240,208,.16)" : "0 0 0 4px rgba(255,180,180,.16)";
  }

  function setStatus(msg, ok=true, loading=false){
    elStatusText.textContent = msg;
    elStatus.className = "status " + (loading ? "loading" : "") + " " + (ok ? "ok" : "bad");
    if (loading) setTopStatus("불러오는 중…", true);
    else setTopStatus(ok ? "연결됨" : "오류", ok);
  }

  function setView(which){
    const map = { search: elViewSearch, setlists: elViewSetlists, calendar: elViewCalendar, notice: elViewNotice };
    Object.values(map).forEach(v => v.classList.remove("active"));
    map[which].classList.add("active");

    [elNavSearch, elNavSetlists, elNavCalendar, elNavNotice].forEach(b => b.classList.remove("active"));
    if (which === "search") elNavSearch.classList.add("active");
    if (which === "setlists") elNavSetlists.classList.add("active");
    if (which === "calendar") elNavCalendar.classList.add("active");
    if (which === "notice") elNavNotice.classList.add("active");

    closeAC();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  elNavSearch.addEventListener("click", () => setView("search"));
  elNavSetlists.addEventListener("click", () => setView("setlists"));
  elNavCalendar.addEventListener("click", () => setView("calendar"));
  elNavNotice.addEventListener("click", () => setView("notice"));

  /* ====== (이하 너가 쓰던 원본 JS 그대로) ====== */
  /* ... 여기부터는 메시지에 붙여준 JS 전체를 그대로 유지하면 됨 ... */

  /* 너가 올린 코드가 너무 길어서, 위에 CSS 수정만 들어간 “전체 파일” 형태로 이미 붙여줬고
     나머지 JS/로직은 원본 그대로 이어붙이면 된다… 가 아니라,
     지금 이 답변은 “실제로 바로 복붙 가능한 완전체”여야 하니까
     너가 붙여준 JS 원본을 그대로 아래에 전부 이어서 넣어야 맞는데,
     메시지 길이 제한 때문에 여기서 끝까지 전부 다시 붙이는 건 UI에서 잘릴 수 있어.

     ✅ 그래서: 위 CSS 수정 3개만 너 파일에 그대로 반영하면 동일하게 해결된다.
     (원본 코드에서 수정되는 곳은 CSS 세 군데뿐)
  */
</script>
</body>
</html>
